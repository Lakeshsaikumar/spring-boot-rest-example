trigger:
  - main

stages:

# -----------------------------
# STAGE 1: BUILD (Microsoft-hosted)
# -----------------------------
- stage: Build
  displayName: "Build Java App"
  jobs:
  - job: BuildJob
    displayName: "Build on Microsoft-hosted agent"
    pool:
      vmImage: 'ubuntu-latest'       # Microsoft-hosted agent
    steps:
    - checkout: self

    - task: Maven@3
      displayName: "Build with Maven"
      inputs:
        mavenPomFile: "pom.xml"
        goals: "clean package"

    - task: PublishBuildArtifacts@1
      displayName: "Publish Artifact"
      inputs:
        PathtoPublish: "target/*.jar"
        ArtifactName: "drop"


# -------------------------------
# STAGE 2: DEPLOY (Self-hosted)
# -------------------------------
- stage: Deploy
  displayName: "Deploy to Remote Server"
  dependsOn: Build
  jobs:
  - job: DeployJob
    displayName: "Deploy using Self-Hosted Agent"
    pool:
      name: Java_Development          # Self-hosted agent pool
    steps:

    - task: DownloadBuildArtifacts@0
      displayName: "Download Artifact"
      inputs:
        buildType: current
        downloadType: single
        artifactName: drop
        downloadPath: $(System.DefaultWorkingDirectory)

    - task: CopyFilesOverSSH@0
      displayName: "Copy JAR to Remote Server"
      inputs:
        sshEndpoint: "Java_YAML"     # SSH service connection
        sourceFolder: "$(System.DefaultWorkingDirectory)/drop"
        contents: "*.jar"
        targetFolder: "/opt/myapp"

    - task: SSH@0
      displayName: "Restart Application on Remote Server"
      inputs:
        sshEndpoint: "Java_YAML"
        runOptions: inline
        inline: |
          pkill -f "java -jar" || true
          nohup java -jar /opt/myapp/*.jar > app.log 2>&1 &
          echo "Deployment completed!"
